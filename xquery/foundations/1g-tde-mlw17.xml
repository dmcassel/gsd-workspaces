<export><workspace name="1g-tde-mlw17"><query name="create and validate template" focus="false" listorder="2" taborder="2" active="true" database="8469375127942903998" server="12590722383439523806" database-name="Documents" server-name="App-Services" mode="xquery">xquery version "1.0-ml";
(:
 : Create a simple Template that defines a SQL view over documents.
 : Validate the Template.
:)

let $my-first-TDE:=
&lt;template xmlns="http://marklogic.com/xdmp/tde"&gt;
 &lt;context&gt;/customer&lt;/context&gt;
   &lt;rows&gt;
     &lt;row&gt;
       &lt;schema-name&gt;customer&lt;/schema-name&gt;
       &lt;view-name&gt;customers&lt;/view-name&gt;
       &lt;columns&gt;
         &lt;column&gt;
           &lt;name&gt;customer_id&lt;/name&gt;
           &lt;scalar-type&gt;long&lt;/scalar-type&gt;
           &lt;val&gt;source/id&lt;/val&gt;
           &lt;invalid-values&gt;ignore&lt;/invalid-values&gt;
         &lt;/column&gt;
        &lt;column&gt;
           &lt;name&gt;last_name&lt;/name&gt;
           &lt;scalar-type&gt;string&lt;/scalar-type&gt;
           &lt;val&gt;source/lname&lt;/val&gt;
           &lt;invalid-values&gt;ignore&lt;/invalid-values&gt;
        &lt;/column&gt;
        &lt;column&gt;
           &lt;name&gt;city&lt;/name&gt;
           &lt;scalar-type&gt;string&lt;/scalar-type&gt;
           &lt;val&gt;source/city&lt;/val&gt;
           &lt;invalid-values&gt;ignore&lt;/invalid-values&gt;
        &lt;/column&gt;
        &lt;column&gt;
           &lt;name&gt;state&lt;/name&gt;
           &lt;scalar-type&gt;string&lt;/scalar-type&gt;
           &lt;val&gt;source/state&lt;/val&gt;
           &lt;invalid-values&gt;ignore&lt;/invalid-values&gt;
        &lt;/column&gt;
        &lt;column&gt;
           &lt;name&gt;shipping_zip&lt;/name&gt;
           &lt;scalar-type&gt;string&lt;/scalar-type&gt;
           &lt;val&gt;canonical/shipping-zip&lt;/val&gt;
           &lt;invalid-values&gt;ignore&lt;/invalid-values&gt;
        &lt;/column&gt;
      &lt;/columns&gt;
    &lt;/row&gt;
  &lt;/rows&gt;
&lt;/template&gt;

return 
 (tde:validate( 
   $my-first-TDE 
   ),
   "You've created and validated your first TDE template."
)</query><query name="test template" focus="false" listorder="3" taborder="3" active="true" database="8469375127942903998" server="12590722383439523806" database-name="Documents" server-name="App-Services" mode="xquery">xquery version "1.0-ml";

(:
 : Create a simple Template that defines a SQL view over documents.
 : Test the Template by seeing which rows are generated when you apply it to a document.
:)

let $my-first-TDE:=
&lt;template xmlns="http://marklogic.com/xdmp/tde"&gt;
 &lt;context&gt;/customer&lt;/context&gt;
   &lt;rows&gt;
     &lt;row&gt;
       &lt;schema-name&gt;customer&lt;/schema-name&gt;
       &lt;view-name&gt;customers&lt;/view-name&gt;
       &lt;columns&gt;
         &lt;column&gt;
           &lt;name&gt;customer_id&lt;/name&gt;
           &lt;scalar-type&gt;long&lt;/scalar-type&gt;
           &lt;val&gt;source/id&lt;/val&gt;
           &lt;invalid-values&gt;ignore&lt;/invalid-values&gt;
         &lt;/column&gt;
        &lt;column&gt;
           &lt;name&gt;last_name&lt;/name&gt;
           &lt;scalar-type&gt;string&lt;/scalar-type&gt;
           &lt;val&gt;source/lname&lt;/val&gt;
           &lt;invalid-values&gt;ignore&lt;/invalid-values&gt;
        &lt;/column&gt;
        &lt;column&gt;
           &lt;name&gt;city&lt;/name&gt;
           &lt;scalar-type&gt;string&lt;/scalar-type&gt;
           &lt;val&gt;source/city&lt;/val&gt;
           &lt;invalid-values&gt;ignore&lt;/invalid-values&gt;
        &lt;/column&gt;
        &lt;column&gt;
           &lt;name&gt;state&lt;/name&gt;
           &lt;scalar-type&gt;string&lt;/scalar-type&gt;
           &lt;val&gt;source/state&lt;/val&gt;
           &lt;invalid-values&gt;ignore&lt;/invalid-values&gt;
        &lt;/column&gt;
        &lt;column&gt;
           &lt;name&gt;shipping_zip&lt;/name&gt;
           &lt;scalar-type&gt;string&lt;/scalar-type&gt;
           &lt;val&gt;canonical/shipping-zip&lt;/val&gt;
           &lt;invalid-values&gt;ignore&lt;/invalid-values&gt;
        &lt;/column&gt;
      &lt;/columns&gt;
    &lt;/row&gt;
  &lt;/rows&gt;
&lt;/template&gt;
return 
 tde:node-data-extract( 
   fn:doc("/customer-2.xml"), 
   $my-first-TDE 
   ) 
</query><query name="insert the template" focus="false" listorder="4" taborder="4" active="true" database="8469375127942903998" server="12590722383439523806" database-name="Documents" server-name="App-Services" mode="xquery">xquery version "1.0-ml";

(:
 : Insert the Template.
 : The function tde:template-insert() will validate the template; insert it into the Schemas database; 
 : and assign the special collection "http://marklogic.com/xdmp/tde"
:)

import module "http://marklogic.com/xdmp/tde" at "/MarkLogic/tde.xqy";

let $my-first-TDE:=
&lt;template xmlns="http://marklogic.com/xdmp/tde"&gt;
 &lt;context&gt;/customer&lt;/context&gt;
   &lt;rows&gt;
     &lt;row&gt;
       &lt;schema-name&gt;customer&lt;/schema-name&gt;
       &lt;view-name&gt;customers&lt;/view-name&gt;
       &lt;columns&gt;
         &lt;column&gt;
           &lt;name&gt;customer_id&lt;/name&gt;
           &lt;scalar-type&gt;long&lt;/scalar-type&gt;
           &lt;val&gt;source/id&lt;/val&gt;
           &lt;invalid-values&gt;ignore&lt;/invalid-values&gt;
         &lt;/column&gt;
        &lt;column&gt;
           &lt;name&gt;last_name&lt;/name&gt;
           &lt;scalar-type&gt;string&lt;/scalar-type&gt;
           &lt;val&gt;source/lname&lt;/val&gt;
           &lt;invalid-values&gt;ignore&lt;/invalid-values&gt;
        &lt;/column&gt;
        &lt;column&gt;
           &lt;name&gt;city&lt;/name&gt;
           &lt;scalar-type&gt;string&lt;/scalar-type&gt;
           &lt;val&gt;source/city&lt;/val&gt;
           &lt;invalid-values&gt;ignore&lt;/invalid-values&gt;
        &lt;/column&gt;
        &lt;column&gt;
           &lt;name&gt;state&lt;/name&gt;
           &lt;scalar-type&gt;string&lt;/scalar-type&gt;
           &lt;val&gt;source/state&lt;/val&gt;
           &lt;invalid-values&gt;ignore&lt;/invalid-values&gt;
        &lt;/column&gt;
        &lt;column&gt;
           &lt;name&gt;shipping_zip&lt;/name&gt;
           &lt;scalar-type&gt;string&lt;/scalar-type&gt;
           &lt;val&gt;canonical/shipping-zip&lt;/val&gt;
           &lt;invalid-values&gt;ignore&lt;/invalid-values&gt;
        &lt;/column&gt;
      &lt;/columns&gt;
    &lt;/row&gt;
  &lt;/rows&gt;
&lt;/template&gt;

return 

( tde:template-insert(
   "/test/my-first-TDE.xml" ,
   $my-first-TDE ,
   xdmp:default-permissions() ,
   "MY-TDE"
  ),
   "You just saved your TDE template template the Schemas database.",
   "Change your database to Schemas, and click 'Explore' to view the template URI."
)
</query><query name="show the view" focus="false" listorder="5" taborder="5" active="true" database="8469375127942903998" server="12590722383439523806" database-name="Documents" server-name="App-Services" mode="xquery">xquery version "1.0-ml";

(:
  Show the view you just created.
:)

 tde:get-view ( "customer", "customers" )
 
</query><query name="simple SQL query" focus="false" listorder="6" taborder="6" active="true" database="8469375127942903998" server="12590722383439523806" database-name="Documents" server-name="App-Services" mode="sql">/*
 # simple SQL query using the SQL mode in Query Console
*/
 
select * from customers

</query><query name="simple SQL XQuery" focus="false" listorder="7" taborder="7" active="true" database="8469375127942903998" server="12590722383439523806" database-name="Documents" server-name="App-Services" mode="xquery">xquery version "1.0-ml";
(:
 # simple SQL query from XQuery
:)
 
xdmp:sql('select * from customers')
</query><query name="simple SQL JavaScript" focus="false" listorder="8" taborder="8" active="true" database="8469375127942903998" server="12590722383439523806" database-name="Documents" server-name="App-Services" mode="javascript">
// simple SQL query from JavaScript

xdmp.sql('select * from customers')
</query><query name="combination query" focus="false" listorder="9" taborder="9" active="true" database="8469375127942903998" server="12590722383439523806" database-name="Documents" server-name="App-Services" mode="xquery">xquery version "1.0-ml";

(:
 # combination SQL query from XQuery
:)
 
xdmp:sql(
  "select 
    customer_id, last_name 
    from customers
    where 
      state = 'Texas'"
    ,
  (),
  (),
  cts:word-query('Novick')
  )
</query><query name="Optic API - XQuery" focus="false" listorder="11" taborder="11" active="true" database="8469375127942903998" server="12590722383439523806" database-name="Documents" server-name="App-Services" mode="xquery">xquery version "1.0-ml";
(:
 # simple SQL query from the Optic API XQuery
:)
 
import module namespace op="http://marklogic.com/optic"
     at "/MarkLogic/optic.xqy";

op:from-view("customer", "customers")
   =&gt; op:select(("customer_id", "last_name", "shipping_zip"))
   =&gt; op:order-by("shipping_zip")
   =&gt; op:result()</query><query name="Optic API JavaScript" focus="false" listorder="13" taborder="12" active="true" database="8469375127942903998" server="12590722383439523806" database-name="Documents" server-name="App-Services" mode="javascript">'use strict';

// simple SQL query from the Optic API JavaScript

const op = require('/MarkLogic/optic');

op.fromView('customer', 'customers')
   .select(['customer_id', 'last_name', 'shipping_zip'])
   .orderBy('shipping_zip')
   .result();
</query><query name="Intro" focus="true" listorder="1" taborder="1" active="true" database="14059993161380782136" server="12590722383439523806" database-name="Schemas" server-name="App-Services" mode="xquery">"
This workspace demonstrates creating a SQL view
on top of our Customer entities using
Template Driven Extraction (TDE) and then querying
through a variety of APIs - JavaScript, Optic, SQL, and XQuery.
"
</query><query name="cleanup schemas" focus="false" listorder="14" taborder="14" active="true" database="14059993161380782136" server="12590722383439523806" database-name="Schemas" server-name="App-Services" mode="xquery">xquery version "1.0-ml";
(:
 : Template documents can be safely deleted once 
 : they have been disabled and after enough time has 
 : elapsed to make sure that the reindexing related to 
 : the disabled template has completed.
 : Run this with the Schemas database selected.
:)
xdmp:collection-delete( "MY-TDE" ),
"You have deleted your template from the Schemas Database."</query><query name="fn:doc()" focus="false" listorder="10" taborder="10" active="true" database="8469375127942903998" server="12590722383439523806" database-name="Documents" server-name="App-Services" mode="xquery">xquery version "1.0-ml";
(:"This script shows us the entity associated with the 
 : results of our combination query in the previous tab.
:)

 fn:doc("/customer-4.xml")</query><query name="disable template" focus="false" listorder="12" taborder="13" active="true" database="8469375127942903998" server="12590722383439523806" database-name="Documents" server-name="App-Services" mode="xquery">xquery version "1.0-ml";

(:
 : Templates can be enabled and disabled by modifying the &lt;enabled&gt; 
 : flag on the template. Set the &lt;enabled&gt; flag to true to enable the 
 : template or false to disable
:)

import module "http://marklogic.com/xdmp/tde" at "/MarkLogic/tde.xqy";

let $my-first-TDE:=
&lt;template xmlns="http://marklogic.com/xdmp/tde"&gt;
 &lt;context&gt;/customer&lt;/context&gt;
 &lt;enabled&gt;false&lt;/enabled&gt;
   &lt;rows&gt;
     &lt;row&gt;
       &lt;schema-name&gt;customer&lt;/schema-name&gt;
       &lt;view-name&gt;customers&lt;/view-name&gt;
       &lt;columns&gt;
         &lt;column&gt;
           &lt;name&gt;customer_id&lt;/name&gt;
           &lt;scalar-type&gt;long&lt;/scalar-type&gt;
           &lt;val&gt;source/id&lt;/val&gt;
           &lt;invalid-values&gt;ignore&lt;/invalid-values&gt;
         &lt;/column&gt;
        &lt;column&gt;
           &lt;name&gt;last_name&lt;/name&gt;
           &lt;scalar-type&gt;string&lt;/scalar-type&gt;
           &lt;val&gt;source/lname&lt;/val&gt;
           &lt;invalid-values&gt;ignore&lt;/invalid-values&gt;
        &lt;/column&gt;
        &lt;column&gt;
           &lt;name&gt;city&lt;/name&gt;
           &lt;scalar-type&gt;string&lt;/scalar-type&gt;
           &lt;val&gt;source/city&lt;/val&gt;
           &lt;invalid-values&gt;ignore&lt;/invalid-values&gt;
        &lt;/column&gt;
        &lt;column&gt;
           &lt;name&gt;state&lt;/name&gt;
           &lt;scalar-type&gt;string&lt;/scalar-type&gt;
           &lt;val&gt;source/state&lt;/val&gt;
           &lt;invalid-values&gt;ignore&lt;/invalid-values&gt;
        &lt;/column&gt;
        &lt;column&gt;
           &lt;name&gt;shipping_zip&lt;/name&gt;
           &lt;scalar-type&gt;string&lt;/scalar-type&gt;
           &lt;val&gt;canonical/shipping-zip&lt;/val&gt;
           &lt;invalid-values&gt;ignore&lt;/invalid-values&gt;
        &lt;/column&gt;
      &lt;/columns&gt;
    &lt;/row&gt;
  &lt;/rows&gt;
&lt;/template&gt;

return 

( tde:template-insert(
   "/test/my-first-TDE.xml" ,
   $my-first-TDE ,
   xdmp:default-permissions() ,
   "MY-TDE"
  ),
   "You've just disabled your TDE template.",
   "Run a SQL query and you will find the view is no longer available."
)</query></workspace></export>
